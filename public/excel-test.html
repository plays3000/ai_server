<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì—‘ì…€ í…œí”Œë¦¿ ë°ëª¨</title>
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
    <style>
        body { font-family: Arial; padding: 20px; }
        #container { width: 100%; height: 600px; margin-top: 20px; }
        button { margin: 10px 5px; padding: 10px 20px; cursor: pointer; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        input[type="number"], input[type="text"] { padding: 8px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ì—‘ì…€ í…œí”Œë¦¿ ë°ëª¨</h1>
    
    <div class="section">
        <h3>1ë‹¨ê³„: í…œí”Œë¦¿ ì—…ë¡œë“œ</h3>
        <input type="number" id="uploadTenantId" placeholder="íšŒì‚¬ ID" value="1">
        <input type="text" id="templateName" placeholder="í…œí”Œë¦¿ ì´ë¦„">
        <input type="file" id="templateFile" accept=".xlsx,.xls">
        <button onclick="uploadTemplate()">í…œí”Œë¦¿ ì—…ë¡œë“œ</button>
        <div id="uploadResult" style="margin-top: 10px; color: green;"></div>
    </div>
    
    <div class="section">
        <h3>2ë‹¨ê³„: í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
        <label>í…œí”Œë¦¿ ID: </label>
        <input type="number" id="templateId" placeholder="í…œí”Œë¦¿ ID" value="1">
        <button onclick="loadTemplate()">í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <div id="loadResult" style="margin-top: 10px; color: blue;"></div>
    </div>
    
    <div class="section">
        <h3>3ë‹¨ê³„: ì‘ì„±í•œ ì—‘ì…€ ì—…ë¡œë“œ (ìë™ ì±„ìš°ê¸°)</h3>
        <input type="file" id="userFile" accept=".xlsx,.xls">
        <button onclick="autoFill()">ìë™ ì±„ìš°ê¸°</button>
        <div id="fillResult" style="margin-top: 10px; color: green;"></div>
    </div>
    
    <h2 id="title">ì—‘ì…€ ë·°ì–´</h2>
    <div id="container"></div>
    
    <script>
        let hot;
        let currentTemplateId;
        
        // 1ë‹¨ê³„: í…œí”Œë¦¿ ì—…ë¡œë“œ
        async function uploadTemplate() {
            const tenantId = document.getElementById('uploadTenantId').value;
            const name = document.getElementById('templateName').value;
            const fileInput = document.getElementById('templateFile');
            
            if (!fileInput.files[0]) {
                alert('í…œí”Œë¦¿ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }
            
            const formData = new FormData();
            formData.append('tenant_id', tenantId);
            formData.append('name', name);
            formData.append('template', fileInput.files[0]);
            
            const res = await fetch('/excel/templates', {
                method: 'POST',
                body: formData
            });
            const result = await res.json();
            
            document.getElementById('uploadResult').innerText = 
                `âœ… ì—…ë¡œë“œ ì„±ê³µ! í…œí”Œë¦¿ ID: ${result.template_id}`;
            
            // ì—…ë¡œë“œ ì„±ê³µ ì‹œ ìë™ìœ¼ë¡œ ID ì…ë ¥
            document.getElementById('templateId').value = result.template_id;
            
            fileInput.value = '';
        }
        
        // 2ë‹¨ê³„: í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadTemplate() {
            const templateId = document.getElementById('templateId').value;
            currentTemplateId = templateId;
            
            const res = await fetch(`/excel/template/view/${templateId}`);
            const result = await res.json();
            
            document.getElementById('title').innerText = `ğŸ“„ ${result.templateName}`;
            document.getElementById('loadResult').innerText = 'âœ… í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!';
            
            renderExcel(result.data, result.mergeCells);
        }
        
        // 3ë‹¨ê³„: ìë™ ì±„ìš°ê¸°
        async function autoFill() {
            if (!currentTemplateId) {
                alert('ë¨¼ì € 2ë‹¨ê³„ì—ì„œ í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”!');
                return;
            }
            
            const fileInput = document.getElementById('userFile');
            if (!fileInput.files[0]) {
                alert('ì‘ì„±í•œ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }
            
            const formData = new FormData();
            formData.append('userFile', fileInput.files[0]);
            
            const res = await fetch(`/excel/template/autofill/${currentTemplateId}`, {
                method: 'POST',
                body: formData
            });
            const result = await res.json();
            
            renderExcel(result.data, result.mergeCells);
            
            document.getElementById('fillResult').innerText = 'âœ… ìë™ ì±„ìš°ê¸° ì™„ë£Œ!';
            
            fileInput.value = '';
        }

        function renderExcel(data, mergeCells) {
            const container = document.getElementById('container');
            
            if (hot) {
                hot.destroy();
            }
            
            hot = new Handsontable(container, {
                data: data,
                colHeaders: true,
                rowHeaders: true,
                width: '100%',
                height: 600,
                mergeCells: mergeCells,
                licenseKey: 'non-commercial-and-evaluation'
            });
        }
    </script>
</body>
</html>