<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI í…œí”Œë¦¿ í•™ìŠµ ê´€ë¦¬ì</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background-color: #f4f6f9; }
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        h2 { margin-top: 0; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        input[type="text"] { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        input[type="file"] { margin-top: 5px; display: block; width: 100%; }
        
        .upload-box { border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 8px; margin-top: 5px; background: #fafafa; }
        .upload-box:hover { border-color: #007bff; background: #f0f7ff; }

        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-top: 20px; width: 100%; font-size: 16px; font-weight: bold; transition: 0.2s; }
        button:hover { background: #0056b3; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; color: #555; }
        .btn-del { background: #ff4d4d; padding: 6px 12px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-del:hover { background: #cc0000; }
        
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .badge-blue { background: #e3f2fd; color: #1565c0; }
        .badge-green { background: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>

    <h1>ğŸ§  AI í…œí”Œë¦¿ í•™ìŠµ ì„¼í„°</h1>

    <div class="card">
        <h2>1. í…œí”Œë¦¿ ìë™ í•™ìŠµ</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
            ë¹ˆ ì–‘ì‹ê³¼ ê¸°ì‘ì„±ëœ ìƒ˜í”Œì„ ì˜¬ë¦¬ë©´, AIê°€ ìŠ¤ìŠ¤ë¡œ ì…ë ¥ì¹¸ì„ ì°¾ì•„ëƒ…ë‹ˆë‹¤. <br>
            <strong>ì¢Œí‘œë¥¼ ì§ì ‘ ì…ë ¥í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤!</strong>
        </p>

        <form id="uploadForm">
            <label>ğŸ“ í…œí”Œë¦¿ ì´ë¦„ (ê³ ìœ  ID)</label>
            <input type="text" id="name" name="name" placeholder="ì˜ˆ: ì¼ì¼ì—…ë¬´ë³´ê³ ì„œ" required>

            <label>ğŸ“„ ë¹ˆ í…œí”Œë¦¿ íŒŒì¼ (í•„ìˆ˜)</label>
            <div class="upload-box">
                <input type="file" id="file" name="file" accept=".xlsx" required>
            </div>

            <label>ğŸ“š ê¸°ì‘ì„± ìƒ˜í”Œ íŒŒì¼ (AI ë¶„ì„ìš© í•„ìˆ˜)</label>
            <div class="upload-box">
                <input type="file" id="samples" name="samples" accept=".xlsx" multiple required>
                <div style="font-size: 12px; color: #888; margin-top: 5px;">
                    * ì´ë¯¸ ì‘ì„±ëœ ì—‘ì…€ íŒŒì¼ì„ 1ê°œ ì´ìƒ ì˜¬ë ¤ì£¼ì„¸ìš”.<br>
                    * AIê°€ [ë¹ˆ íŒŒì¼]ê³¼ [ìƒ˜í”Œ]ì„ ë¹„êµí•´ì„œ ì…ë ¥ ìœ„ì¹˜ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                </div>
            </div>

            <button type="submit">ğŸ¤– AI ë¶„ì„ ë° í•™ìŠµ ì‹œì‘</button>
        </form>
        <div id="result" style="margin-top: 15px; font-weight: bold; text-align: center;"></div>
    </div>

    <div class="card">
        <h2>2. í•™ìŠµëœ í…œí”Œë¦¿ ëª©ë¡</h2>
        <table>
            <thead>
                <tr>
                    <th>ì´ë¦„</th>
                    <th>ë²„ì „</th>
                    <th>ìƒíƒœ</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="templateList"></tbody>
        </table>
    </div>
</body>
<script>
     async function loadList() {
    const res = await fetch('/chat');
    const list = await res.json();
    const tbody = document.getElementById('templateList');
    tbody.innerHTML = '';

    list.forEach(item => {
        let schemaInfo = "ë¶„ì„ ëŒ€ê¸°";
        try {
            const schema = typeof item.schema_def === 'string' ? JSON.parse(item.schema_def) : item.schema_def;
            const mapCount = schema.mappings ? schema.mappings.length : 0;
            schemaInfo = `<span class="badge badge-green">${mapCount}ê°œ í•„ë“œ í•™ìŠµë¨</span>`;
        } catch(e) {}

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:bold;">${item.name}</td>
            <td><span class="badge badge-blue">v${item.version}</span></td>
            <td>${schemaInfo}</td>
            <td><button class="btn-del" onclick="deleteTemplate('${item.name}')">ì‚­ì œ</button></td>
        `;
        tbody.appendChild(tr);
    });
}

async function deleteTemplate(name) {
    if (!confirm(`'${name}' í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    try {
        const res = await fetch('/templates/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        if ((await res.json()).success) { loadList(); }
    } catch (e) { alert('ì˜¤ë¥˜ ë°œìƒ'); }
}

document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const resultDiv = document.getElementById('result');
    
    resultDiv.innerHTML = '<span style="color:blue">â³ AIê°€ ì—‘ì…€ êµ¬ì¡°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ì•½ 30ì´ˆ ì†Œìš”)</span>';
    const btn = e.target.querySelector('button');
    btn.disabled = true;

    try {
        const res = await fetch('/templates/learn', { method: 'POST', body: formData });
        const data = await res.json();

        if (data.success) {
            resultDiv.innerHTML = `<span style="color:green">âœ… í•™ìŠµ ì™„ë£Œ! (í•„ë“œ ${data.mappedFields}ê°œ ë°œê²¬)</span>`;
            e.target.reset();
            loadList();
        } else {
            resultDiv.innerHTML = `<span style="color:red">âŒ ì˜¤ë¥˜: ${data.error}</span>`;
        }
    } catch (err) {
        resultDiv.innerText = 'ì„œë²„ í†µì‹  ì˜¤ë¥˜';
    } finally {
        btn.disabled = false;
    }
});
</script>
</html>